VERSION="1.20171029-1"
SRCDIR="linux-raspberrypi-kernel_${VERSION}"
TARBALL="raspberrypi-kernel_${VERSION}.tar.gz"
URL="https://github.com/raspberrypi/linux/archive"
SHA256SUM="348b9f0c770271ecc95603a495f2a2197a1056efc5d81b42ebd155cddcfee4ee"
DEPENDS="initrd"

prepare() {
	return
}

build() {
	local INITRDLIST="$PKGDEPLOYDIR/initrd/initrd.list"

	export KBUILD_OUTPUT="$PKGBUILDDIR"
	make -C "$1" O="$PKGBUILDDIR" ARCH="arm" CROSS_COMPILE="${TARGET}-" mrproper

	cat_file_override "linux.config" > "$PKGBUILDDIR/.config"
	sed -i "$PKGBUILDDIR/.config" -e 's,^CONFIG_CROSS_COMPILE=.*,CONFIG_CROSS_COMPILE="'$TARGET'-",'
	sed -i "$PKGBUILDDIR/.config" -e 's,^CONFIG_INITRAMFS_SOURCE=.*,CONFIG_INITRAMFS_SOURCE="'$INITRDLIST'",'
	make -C "$1" O="$PKGBUILDDIR" ARCH="arm" CROSS_COMPILE="${TARGET}-" oldconfig

	sed -i "$PKGBUILDDIR/.config" -e 's,^CONFIG_CROSS_COMPILE=.*,CONFIG_CROSS_COMPILE="'$TARGET'-",'
	sed -i "$PKGBUILDDIR/.config" -e 's,^CONFIG_INITRAMFS_SOURCE=.*,CONFIG_INITRAMFS_SOURCE="'$INITRDLIST'",'
	sed -i "$PKGBUILDDIR/.config" -e 's,^CONFIG_LOCALVERSION=.*,CONFIG_LOCALVERSION="-'${OS_NAME}-${OS_RELEASE}'",'
	make -C "$1" O="$PKGBUILDDIR" ARCH="arm" CROSS_COMPILE="${TARGET}-" -j $NUMJOBS zImage dtbs
}

deploy() {
	local SOURCE="$1"
	local DEPLOY="$2"

	install -m 755 "arch/arm/boot/zImage" "$DEPLOY/vmlinuz"
}
