# inherit package details from first stage GCC
source "$SCRIPTDIR/pkg/tc-gcc1/build"
DEPENDS="tc-gcc1 musl linux_headers"

build() {
	local extra=""

	if [ "x$TC_HARDENING" = "xyes" ]; then
		extra="--enable-libssp --enable-default-pie"
		extra="$extra --enable-default-ssp"
	else
		extra="--disable-libssp"
	fi

	$1/configure --prefix="$TCDIR" --target="$TARGET" \
		     --build="$HOSTTUPLE" --host="$HOSTTUPLE" \
		     --with-sysroot="$TCDIR/$TARGET" \
		     --disable-nls --enable-languages=c,c++ \
		     --enable-c99 --enable-long-long \
		     --enable-libmudflap --disable-multilib \
		     --disable-libsanitizer \
		     --with-arch="$GCC_CPU" $extra $GCC_EXTRACFG \
		     --with-native-system-header-dir="/include"

	make -j $NUMJOBS
}

deploy() {
	local SOURCE="$1"
	local DEPLOY="$2"

	make install

	local f dep

	for f in $(ls ${TCDIR}/${TARGET}/include); do
		for dep in $DEPENDS; do
			if [ -e ${PKGDEPLOYDIR}/${dep}/include/$f ]; then
				rm -rf "$TCDIR/$TARGET/include/$f"
			fi
		done
	done

	for f in $(ls ${TCDIR}/${TARGET}/lib); do
		for dep in $DEPENDS; do
			if [ -e ${PKGDEPLOYDIR}/${dep}/lib/$f ]; then
				rm -rf "$TCDIR/$TARGET/lib/$f"
			fi
		done
	done

	mkdir -p "$DEPLOY/lib"
	mv ${TCDIR}/${TARGET}/{include,lib} "$DEPLOY"
	rm ${DEPLOY}/lib/*.la
	cp "$SCRIPTDIR/pkg/$PKGNAME/rootfs_files.txt" "$DEPLOY"

	if [ "x$TC_HARDENING" = "xyes" ]; then
		cat >> "$DEPLOY/rootfs_files.txt" <<_EOF
lib/libssp.so m 777 0 0
lib/libssp.so.0 m 777 0 0
lib/libssp.so.0.0.0 m 555 0 0
_EOF
	fi
}
