VERSION="1.7.0"
SRCDIR="unbound-${VERSION}"
TARBALL="${SRCDIR}.tar.gz"
URL="https://www.unbound.net/downloads"
SHA256SUM="94dd9071fb13d8ccd122a3ac67c4524a3324d0e771fc7a8a7c49af8abfb926a2"
DEPENDS="libevent openssl expat"

prepare() {
	return
}

build() {
	$1/configure --prefix="" --host="$TARGET" --disable-static \
		     --sysconfdir=/etc --with-pidfile=/run/unbound.pid \
		     --sbindir=/bin --with-libexpat="$TCDIR/$TARGET" \
		     --with-ssl="$TCDIR/$TARGET"

	make -j $NUMJOBS
}

deploy() {
	local SOURCE="$1"
	local DEPLOY="$2"
	local DEVDEPLOY="$3"

	make DESTDIR="$DEPLOY" install

	rm -r "$DEPLOY/share"

	mkdir -p "$DEPLOY/etc/unbound/unbound.conf.d"
	mkdir -p "$DEPLOY/var/lib/unbound"

	cat > "$DEPLOY/etc/unbound/unbound.conf" << _EOF
include: "/etc/unbound/unbound.conf.d/*.conf"
_EOF

	cat_file_override "unbound.conf" > \
		"$DEPLOY/etc/unbound/unbound.conf.d/server.conf"

	split_dev_deploy "$DEPLOY" "$DEVDEPLOY"
	strip_files ${DEPLOY}/{bin,lib}/*
}

check_update() {
	curl --silent -L "$URL" | grep -o ">unbound-[0-9.]*tar.gz<" | \
	    sed 's/>unbound-//g' | sed 's/.tar.gz<//g' | \
	    verson_find_greatest "$VERSION"
}