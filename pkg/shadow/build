VERSION="4.6"
SRCDIR="shadow-${VERSION}"
TARBALL="${SRCDIR}.tar.xz"
URL="https://github.com/shadow-maint/shadow/releases/download/${VERSION}"
SHA256SUM="0998c8d84242a231ab0acb7f8613927ff5bcff095f8aa6b79478893a03f05583"
DEPENDS="toolchain"

prepare() {
	sed -i 's/groups$(EXEEXT) //' src/Makefile.in

	sed -i -e 's@#ENCRYPT_METHOD DES@ENCRYPT_METHOD SHA512@' \
		-e 's@/var/spool/mail@/var/mail@' etc/login.defs
}

build() {
	run_configure "$1" --disable-man --without-libpam --without-selinux \
		     --with-sha-crypt --with-group-name-max-length=32

	make -j $NUMJOBS
}

deploy() {
	local SOURCE="$1"
	local DEPLOY="$2"

	make DESTDIR="$DEPLOY" install
	cp "$SCRIPTDIR/pkg/$PKGNAME/rootfs_files.txt" "$DEPLOY"

	sed -i -e 's@HOME=/home@HOME=/usr@g' $DEPLOY/etc/default/useradd

	# *hrmpf*
	if [ -e "$DEPLOY/sbin" ]; then
		mv ${DEPLOY}/sbin/* ${DEPLOY}/bin
		rmdir ${DEPLOY}/sbin
	fi
}

check_update() {
	curl --silent -L https://github.com/shadow-maint/shadow/releases | \
	    grep -o "shadow-[0-9.]*tar.xz" | \
	    sed 's/shadow-//g' | sed 's/.tar.xz//g' | \
	    verson_find_greatest "$VERSION"
}