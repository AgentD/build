VERSION="4.5"
SRCDIR="shadow-${VERSION}"
TARBALL="${SRCDIR}.tar.xz"
URL="https://github.com/shadow-maint/shadow/releases/download/${VERSION}"
SHA256SUM="fc8c858381ad577a5c25ff5beb6ee60a34f8719c73e4e7c61e74188b4e54b741"
DEPENDS="toolchain"

prepare() {
	sed -i 's/groups$(EXEEXT) //' src/Makefile.in

	sed -i -e 's@#ENCRYPT_METHOD DES@ENCRYPT_METHOD SHA512@' \
		-e 's@/var/spool/mail@/var/mail@' etc/login.defs
}

build() {
	$1/configure --prefix="" --host="$TARGET" --sbindir=/bin \
		     --disable-man --without-libpam --without-selinux \
		     --with-sha-crypt --with-group-name-max-length=32

	make -j $NUMJOBS
}

deploy() {
	local SOURCE="$1"
	local DEPLOY="$2"

	make DESTDIR="$DEPLOY" install-strip

	sed -i -e 's@HOME=/home@HOME=/usr@g' $DEPLOY/etc/default/useradd

	rm -rf "$DEPLOY/share"

	# *hrmpf*
	if [ -e "$DEPLOY/sbin" ]; then
		mv ${DEPLOY}/sbin/* ${DEPLOY}/bin
		rmdir ${DEPLOY}/sbin
	fi

	rm $DEPLOY/bin/{vigr,vipw,chsh}
}

check_update() {
	curl --silent -L https://github.com/shadow-maint/shadow/releases | \
	    grep -o "shadow-[0-9.]*tar.xz" | \
	    sed 's/shadow-//g' | sed 's/.tar.xz//g' | \
	    verson_find_greatest "$VERSION"
}