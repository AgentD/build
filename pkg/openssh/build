VERSION="7.8p1"
SRCDIR="openssh-${VERSION}"
TARBALL="${SRCDIR}.tar.gz"
URL="https://cloudflare.cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable"
SHA256SUM="1a484bb15152c183bb2514e112aa30dd34138c3cfb032eee5490a66c507144ca"
DEPENDS="openssl zlib"

prepare() {
	apply_patches
}

build() {
	run_configure "$1" --with-pie --without-pam --without-stackprotect \
		     --without-selinux --disable-strip \
		     --with-sandbox=seccomp_filter \
		     --with-privsep-path=/var/lib/sshd

	make -j $NUMJOBS
}

deploy() {
	local SOURCE="$1"
	local DEPLOY="$2"

	make DESTDIR="$DEPLOY" install
	cp "$SCRIPTDIR/pkg/$PKGNAME/rootfs_files.txt" "$DEPLOY"
	mkdir -p "$DEPLOY/var/lib/sshd"
	install -v -m755 "$SOURCE/contrib/ssh-copy-id" "$DEPLOY/bin"

	cat_file_override "sshd_config" > "$DEPLOY/etc/sshd_config"
}

check_update() {
	local version=$(echo $VERSION | sed 's/p/./g')

	curl --silent -L "$URL" | grep -o ">openssh-[0-9.]*p[0-9]*.tar.gz<" | \
	    sed 's/>openssh-//g' | sed 's/.tar.gz<//g' | sed 's/p/./g' | \
	    verson_find_greatest "$version"
}