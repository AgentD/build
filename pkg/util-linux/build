VERSION="2.32"
SRCDIR="util-linux-${VERSION}"
TARBALL="${SRCDIR}.tar.xz"
URL="https://www.kernel.org/pub/linux/utils/util-linux/v$VERSION/"
SHA256SUM="6c7397abc764e32e8159c2e96042874a190303e77adceb4ac5bd502a272a4734"
DEPENDS="bash ncurses zlib"

prepare() {
	apply_patches
}

build() {
	$1/configure ADJTIME_PATH=/var/lib/hwclock/adjtime \
		     --prefix="" --host="$TARGET" --sbindir="/bin" \
		     --with-bashcompletiondir="/share/bash-completion/completions" \
		     --disable-pylibmount --disable-static --without-python \
		     --without-systemd --without-systemdsystemunitdir \
		     --disable-cal --disable-chmem --disable-fdformat \
		     --disable-fsck --disable-logger --disable-mesg \
		     --disable-minix --disable-bfs --disable-more \
		     --disable-nologin --disable-nsenter --disable-pivot_root \
		     --disable-raw --disable-sulogin --disable-switch_root \
		     --disable-ul --disable-unshare --disable-utmpdump \
		     --disable-uuidd --disable-wall --disable-zramctl \
		     --disable-makeinstall-chown \
		     --disable-makeinstall-setuid \
		     --enable-agetty

	make -j $NUMJOBS
}

deploy() {
	local SOURCE="$1"
	local DEPLOY="$2"
	local DEVDEPLOY="$3"
	local UTIL

	mkdir -p "$DEPLOY/var/lib/hwclock"

	make DESTDIR="$DEPLOY" install
	strip_files ${DEPLOY}/{bin,lib}/*

	rm -r "$DEPLOY/share/man" "$DEPLOY/share/doc"

	if [ -e "$DEPLOY/sbin" ]; then
		mv ${DEPLOY}/sbin/* ${DEPLOY}/bin
		rmdir ${DEPLOY}/sbin
	fi

	for UTIL in chcpu chrt col colcrt colrm column ctrlaltdel setarch \
		    isosize look lsns mcookie mkfs mkswap readprofile rev \
		    script scriptreplay setsid swaplabel swapoff swapon \
		    uname26 i386 linux32 linux64 whereis last lastb \
		    lslogins fsck.cramfs mkfs.cramfs;
	do
		local path="$DEPLOY/bin/$UTIL"

		if [ -f "$path" ] || [ -L "$path" ]; then
			rm "$path"
		fi
	done

	split_dev_deploy "$DEPLOY" "$DEVDEPLOY"
}

check_update() {
	curl --silent -L "https://www.kernel.org/pub/linux/utils/util-linux" | \
	    grep -o "v[0-9.]*/" | grep -o "[0-9.]*" | \
	    verson_find_greatest "$VERSION"
}